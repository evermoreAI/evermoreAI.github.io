<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evermore — Obituary Writer for Funeral Professionals</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1612;
    --ink-soft: #4a4540;
    --ink-faint: #8a8480;
    --cream: #faf8f4;
    --cream-dark: #f0ece4;
    --gold: #b8975a;
    --gold-light: #d4b07a;
    --gold-pale: #f5eedd;
    --sage: #6b7c6e;
    --border: #e0d8cc;
    --white: #ffffff;
    --shadow: 0 4px 24px rgba(26,22,18,0.08);
    --shadow-lg: 0 12px 48px rgba(26,22,18,0.14);
  }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── GRAIN OVERLAY ── */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.4;
  }

  /* ── NAV ── */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 48px;
    background: rgba(250,248,244,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px;
    font-weight: 500;
    letter-spacing: 0.04em;
    color: var(--ink);
  }

  .logo span {
    color: var(--gold);
  }

  .nav-tag {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--ink-faint);
    background: var(--cream-dark);
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  /* ── HERO ── */
  .hero {
    padding: 160px 48px 80px;
    max-width: 900px;
    margin: 0 auto;
    text-align: center;
  }

  .hero-eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 28px;
  }

  .hero-eyebrow::before,
  .hero-eyebrow::after {
    content: '';
    display: block;
    width: 24px;
    height: 1px;
    background: var(--gold);
    opacity: 0.6;
  }

  h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(42px, 6vw, 72px);
    font-weight: 300;
    line-height: 1.1;
    letter-spacing: -0.01em;
    color: var(--ink);
    margin-bottom: 24px;
  }

  h1 em {
    font-style: italic;
    color: var(--gold);
  }

  .hero-sub {
    font-size: 17px;
    font-weight: 300;
    color: var(--ink-soft);
    line-height: 1.7;
    max-width: 560px;
    margin: 0 auto 48px;
  }

  /* ── MAIN APP CARD ── */
  .app-section {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 48px 80px;
  }

  .app-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }

  .app-header {
    background: var(--ink);
    padding: 24px 36px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .app-header-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 400;
    color: var(--cream);
    letter-spacing: 0.04em;
  }

  .step-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .step-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    transition: background 0.3s;
  }
  .step-dot.active { background: var(--gold); }
  .step-dot.done { background: rgba(255,255,255,0.5); }

  .app-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 640px;
  }

  /* ── FORM PANEL ── */
  .form-panel {
    padding: 40px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
  }

  .form-section-title {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--gold-pale);
  }

  .field-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  .field-grid.single { grid-template-columns: 1fr; }
  .field-grid.third { grid-template-columns: 1fr 1fr 1fr; }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  label {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--ink-soft);
  }

  input, select, textarea {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 400;
    color: var(--ink);
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--gold);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(184,151,90,0.1);
  }

  textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

  select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8480' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
    cursor: pointer;
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 28px 0;
  }

  .tone-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 24px;
  }

  .tone-btn {
    padding: 10px 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--cream);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--ink-soft);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .tone-btn:hover {
    border-color: var(--gold);
    color: var(--gold);
  }

  .tone-btn.selected {
    background: var(--ink);
    border-color: var(--ink);
    color: var(--cream);
  }

  .generate-btn {
    width: 100%;
    padding: 16px;
    background: var(--ink);
    color: var(--cream);
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 500;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all 0.25s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 24px;
    position: relative;
    overflow: hidden;
  }

  .generate-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gold);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
  }

  .generate-btn:hover::before { transform: scaleX(1); }
  .generate-btn:hover { color: var(--ink); }
  .generate-btn span { position: relative; z-index: 1; }

  .generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .generate-btn:disabled::before { transform: scaleX(0); }

  /* ── OUTPUT PANEL ── */
  .output-panel {
    padding: 40px;
    display: flex;
    flex-direction: column;
    background: #fdfcfa;
  }

  .output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
  }

  .output-label {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--ink-faint);
  }

  .output-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 7px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--white);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--ink-soft);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .action-btn:hover {
    border-color: var(--ink);
    color: var(--ink);
    background: var(--cream);
  }

  .action-btn.primary {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--white);
  }

  .action-btn.primary:hover {
    background: var(--gold-light);
    border-color: var(--gold-light);
    color: var(--white);
  }

  /* Format tabs */
  .format-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: var(--cream-dark);
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .format-tab {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--ink-faint);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .format-tab.active {
    background: var(--white);
    color: var(--ink);
    box-shadow: 0 1px 4px rgba(26,22,18,0.08);
  }

  /* Output text area */
  .output-content {
    flex: 1;
    position: relative;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 340px;
    text-align: center;
    color: var(--ink-faint);
  }

  .empty-icon {
    width: 56px; height: 56px;
    margin-bottom: 16px;
    opacity: 0.3;
  }

  .empty-state p {
    font-size: 14px;
    font-weight: 300;
    line-height: 1.6;
    max-width: 240px;
  }

  .output-text {
    display: none;
    flex-direction: column;
    height: 100%;
  }

  .output-text.visible { display: flex; }

  .output-textarea {
    flex: 1;
    min-height: 340px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 1.8;
    color: var(--ink);
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
  }

  .output-textarea:focus {
    border-color: var(--gold);
  }

  .word-count {
    margin-top: 8px;
    font-size: 11px;
    color: var(--ink-faint);
    text-align: right;
  }

  /* Loading state */
  .loading-state {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 340px;
    gap: 20px;
  }

  .loading-state.visible { display: flex; }

  .loading-ornament {
    width: 48px;
    height: 48px;
    position: relative;
  }

  .loading-ring {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: var(--gold);
    animation: spin 1s linear infinite;
  }

  .loading-ring:nth-child(2) {
    inset: 6px;
    border-top-color: transparent;
    border-right-color: var(--ink);
    animation-duration: 1.4s;
    animation-direction: reverse;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    font-weight: 300;
    color: var(--ink-soft);
    font-style: italic;
  }

  .loading-sub {
    font-size: 12px;
    color: var(--ink-faint);
    letter-spacing: 0.04em;
  }

  /* ── FORMATS SECTION ── */
  .formats-bar {
    display: none;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .formats-bar.visible { display: flex; }

  .format-chip {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    color: var(--ink-soft);
    background: var(--cream);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .format-chip:hover {
    border-color: var(--gold);
    color: var(--gold);
    background: var(--gold-pale);
  }

  .format-chip svg { width: 12px; height: 12px; }

  /* ── FOOTER STRIP ── */
  .footer-strip {
    background: var(--ink);
    padding: 16px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 0 0 20px 20px;
  }

  .footer-strip-text {
    font-size: 12px;
    color: rgba(255,255,255,0.4);
  }

  .footer-strip-text strong {
    color: var(--gold);
    font-weight: 500;
  }

  .cases-badge {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .pulse-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s ease infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.85); }
  }

  /* NOTIFICATION */
  .notification {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--ink);
    color: var(--cream);
    padding: 14px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 400;
    box-shadow: var(--shadow-lg);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 9998;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 320px;
  }

  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  .notification-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--gold);
    flex-shrink: 0;
  }

  /* ── API KEY BANNER ── */
  .api-banner {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 200;
    background: var(--ink);
    padding: 14px 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  }

  .api-banner-text {
    font-size: 13px;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
  }

  .api-banner-text strong { color: var(--gold); }

  .api-key-input {
    flex: 1;
    max-width: 420px;
    padding: 9px 14px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 7px;
    font-family: 'DM Sans', monospace;
    font-size: 13px;
    color: var(--cream);
    outline: none;
    transition: border-color 0.2s;
  }

  .api-key-input::placeholder { color: rgba(255,255,255,0.3); }
  .api-key-input:focus { border-color: var(--gold); }

  .api-save-btn {
    padding: 9px 20px;
    background: var(--gold);
    color: var(--ink);
    border: none;
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
  }

  .api-save-btn:hover { background: var(--gold-light); }

  .api-status {
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .api-status.connected { color: #4caf50; }
  .api-status.disconnected { color: rgba(255,255,255,0.4); }

  .api-change-btn {
    font-size: 11px;
    color: var(--gold);
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font-family: 'DM Sans', sans-serif;
  }

  

  /* ANIMATIONS */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .hero { animation: fadeUp 0.7s ease both; }
  .app-section { animation: fadeUp 0.7s ease 0.15s both; }
  .social-proof { animation: fadeUp 0.7s ease 0.25s both; }

  /* RESPONSIVE */
  @media (max-width: 860px) {
    nav { padding: 16px 24px; }
    .hero { padding: 120px 24px 60px; }
    .app-section { padding: 0 24px 60px; }
    .app-body { grid-template-columns: 1fr; }
    .form-panel { border-right: none; border-bottom: 1px solid var(--border); }
    .social-proof { grid-template-columns: 1fr; padding: 0 24px; }
    .pricing { padding: 0 24px; }
  
    .field-grid { grid-template-columns: 1fr; }
    .field-grid.third { grid-template-columns: 1fr 1fr; }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>



<section class="app-section">
  <div class="app-card">
    <div class="app-header">
      <div class="app-header-title">New Tribute — Case #1042</div>
      <div class="step-indicator">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
      </div>
    </div>

    <div class="app-body">
      <!-- FORM -->
      <div class="form-panel">
        <div class="form-section-title">Personal Information</div>

        <div class="field-grid">
          <div class="field">
            <label>First Name</label>
            <input type="text" id="firstName" placeholder="Margaret" value="">
          </div>
          <div class="field">
            <label>Last Name</label>
            <input type="text" id="lastName" placeholder="Sullivan" value="">
          </div>
        </div>

        <div class="field-grid third">
          <div class="field">
            <label>Age</label>
            <input type="number" id="age" placeholder="78" min="0" max="130">
          </div>
          <div class="field">
            <label>Date of Birth</label>
            <input type="text" id="dob" placeholder="March 4, 1946">
          </div>
          <div class="field">
            <label>Date of Passing</label>
            <input type="text" id="dod" placeholder="Feb 21, 2026">
          </div>
        </div>

        <div class="field-grid">
          <div class="field">
            <label>City / Hometown</label>
            <input type="text" id="city" placeholder="Portland, Oregon">
          </div>
          <div class="field">
            <label>Occupation</label>
            <input type="text" id="occupation" placeholder="Retired schoolteacher">
          </div>
        </div>

        <div class="divider"></div>
        <div class="form-section-title">Family & Legacy</div>

        <div class="field-grid single">
          <div class="field">
            <label>Survived By (names & relationships)</label>
            <textarea id="survivors" placeholder="Husband Robert, daughters Anne and Claire, four grandchildren..." rows="2"></textarea>
          </div>
        </div>

        <div class="field-grid single">
          <div class="field">
            <label>Predeceased By</label>
            <input type="text" id="predeceased" placeholder="Parents John and Helen, brother Thomas">
          </div>
        </div>

        <div class="divider"></div>
        <div class="form-section-title">Life Story</div>

        <div class="field-grid single">
          <div class="field">
            <label>Passions, Hobbies & Interests</label>
            <textarea id="hobbies" placeholder="Gardening, church choir, teaching Sunday school, cooking for the neighborhood..."></textarea>
          </div>
        </div>

        <div class="field-grid single">
          <div class="field">
            <label>Notable Achievements or Character</label>
            <textarea id="achievements" placeholder="Taught 3rd grade for 28 years, known for her warm laugh and open-door policy..."></textarea>
          </div>
        </div>

        <div class="field-grid">
          <div class="field">
            <label>Religion / Faith</label>
            <select id="religion">
              <option value="">Not specified</option>
              <option>Christian — Catholic</option>
              <option>Christian — Protestant</option>
              <option>Christian — Baptist</option>
              <option>Jewish</option>
              <option>Muslim</option>
              <option>Hindu</option>
              <option>Buddhist</option>
              <option>Non-religious / Secular</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label>Service Type</label>
            <select id="serviceType">
              <option>Funeral Service</option>
              <option>Celebration of Life</option>
              <option>Memorial Service</option>
              <option>Graveside Service</option>
              <option>Private Family Service</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <div class="form-section-title">Tone & Style</div>

        <div class="tone-grid">
          <button class="tone-btn selected" data-tone="Warm & Traditional" onclick="selectTone(this)">Warm & Traditional</button>
          <button class="tone-btn" data-tone="Poetic & Literary" onclick="selectTone(this)">Poetic & Literary</button>
          <button class="tone-btn" data-tone="Celebratory" onclick="selectTone(this)">Celebratory</button>
          <button class="tone-btn" data-tone="Brief & Dignified" onclick="selectTone(this)">Brief & Dignified</button>
          <button class="tone-btn" data-tone="Personal & Conversational" onclick="selectTone(this)">Personal & Warm</button>
          <button class="tone-btn" data-tone="Religious & Devotional" onclick="selectTone(this)">Religious</button>
        </div>

        <div class="field-grid">
          <div class="field">
            <label>Word Count Target</label>
            <select id="wordCount">
              <option value="150">Short — ~150 words</option>
              <option value="250" selected>Standard — ~250 words</option>
              <option value="400">Full — ~400 words</option>
              <option value="600">Extended — ~600 words</option>
            </select>
          </div>
          <div class="field">
            <label>Newspaper</label>
            <input type="text" id="newspaper" placeholder="The Oregonian">
          </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateObituary()">
          <span>✦ Generate Tribute</span>
        </button>
      </div>

      <!-- OUTPUT -->
      <div class="output-panel">
        <div class="output-header">
          <div class="output-label">Generated Tribute</div>
          <div class="output-actions" id="outputActions" style="display:none">
            <button class="action-btn" onclick="copyText()">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M11 5V3.5A1.5 1.5 0 009.5 2h-6A1.5 1.5 0 002 3.5v6A1.5 1.5 0 003.5 11H5" stroke="currentColor" stroke-width="1.5"/></svg>
              Copy
            </button>
            <button class="action-btn primary" onclick="exportToPDF()">
              Export PDF
            </button>
          </div>
        </div>

        <div class="format-tabs" id="formatTabs" style="display:none">
          <button class="format-tab active" onclick="switchFormat(this, 'full')">Full Obituary</button>
          <button class="format-tab" onclick="switchFormat(this, 'short')">Newspaper Notice</button>
          <button class="format-tab" onclick="switchFormat(this, 'social')">Social Post</button>
          <button class="format-tab" onclick="switchFormat(this, 'program')">Service Program</button>
        </div>

        <div class="output-content">
          <!-- Empty state -->
          <div class="empty-state" id="emptyState">
            <svg class="empty-icon" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M28 8C17 8 8 17 8 28s9 20 20 20 20-9 20-20S39 8 28 8z" stroke="currentColor" stroke-width="1.5"/>
              <path d="M28 18v10l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M20 34c1.5 2.5 4.5 4 8 4s6.5-1.5 8-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <p>Fill in the details on the left and click <strong>Generate Tribute</strong> to create a dignified obituary in seconds.</p>
          </div>

          <!-- Loading state -->
          <div class="loading-state" id="loadingState">
            <div class="loading-ornament">
              <div class="loading-ring"></div>
              <div class="loading-ring"></div>
            </div>
            <div class="loading-text">Composing tribute...</div>
            <div class="loading-sub">Crafting with care</div>
          </div>

          <!-- Output -->
          <div class="output-text" id="outputText">
            <textarea class="output-textarea" id="outputArea" spellcheck="true" placeholder="Your generated obituary will appear here..."></textarea>
            <div class="word-count" id="wordCountDisplay"></div>
          </div>
        </div>

        <div class="formats-bar" id="formatsBar">
          <div class="format-chip" onclick="reformatFor('The Oregonian (250 words)')">
            <svg viewBox="0 0 12 12" fill="none"><rect x="1" y="1" width="10" height="10" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M3 4h6M3 6h4M3 8h5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
            Newspaper
          </div>
          <div class="format-chip" onclick="reformatFor('funeral home website (150 words)')">
            <svg viewBox="0 0 12 12" fill="none"><circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.2"/><path d="M6 3v3l2 2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
            Website
          </div>
          <div class="format-chip" onclick="reformatFor('Facebook memorial post (100 words, warm)')">
            <svg viewBox="0 0 12 12" fill="none"><path d="M6 1l1.5 3h3l-2.5 2 1 3L6 7.5 3 9l1-3L1.5 4h3z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
            Social
          </div>
          <div class="format-chip" onclick="reformatFor('service program (80 words, formal)')">
            <svg viewBox="0 0 12 12" fill="none"><rect x="2" y="1" width="8" height="10" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M4 4h4M4 6h3M4 8h2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
            Program
          </div>
        </div>
      </div>
    </div>

    <div class="footer-strip">
      <div class="footer-strip-text">
        Saved automatically to <strong>Case #1042</strong> — Sullivan, Margaret
      </div>
      <div class="cases-badge">
        <div class="pulse-dot"></div>
        Auto-saving
      </div>
    </div>
  </div>
</section>

<!-- Notification -->
<div class="notification" id="notification">
  <div class="notification-dot"></div>
  <span id="notificationText">Copied to clipboard</span>
</div>

<script>
let selectedTone = 'Warm & Traditional';
let generatedTexts = {};
let currentFormat = 'full';
let isGenerating = false;
let ANTHROPIC_API_KEY = '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';

// ── API KEY MANAGEMENT ──
function initApiKey() {
  showConnected();
}


function showConnected() {
  document.body.classList.add('has-api-key');
}

function resetApiKey() {
  localStorage.removeItem('evermore_api_key');
  ANTHROPIC_API_KEY = '';
  document.body.classList.remove('has-api-key');
}

// Allow pressing Enter in key input
document.addEventListener('DOMContentLoaded', () => {
  initApiKey();
  prefillFromUrl();
  // URL param prefill
  function prefillFromUrl() {
    const p = new URLSearchParams(window.location.search);
    if (!p.toString()) return;
    const nameParts = (p.get('name') || '').trim().split(' ');
    if (nameParts.length > 0) document.getElementById('firstName').value = nameParts[0];
    if (nameParts.length > 1) document.getElementById('lastName').value = nameParts.slice(1).join(' ');
    if (p.get('dod')) document.getElementById('dod').value = p.get('dod');
    if (p.get('city')) document.getElementById('city').value = p.get('city');
    const svcMap = { 'burial': 'Funeral Service', 'cremation': 'Memorial Service' };
    if (p.get('service_type')) {
      const mapped = svcMap[p.get('service_type').toLowerCase()];
      if (mapped) document.getElementById('serviceType').value = mapped;
    }
    if (p.get('case_number')) {
      document.querySelector('.app-header-title').textContent = 'New Tribute — ' + p.get('case_number');
      document.querySelector('.footer-strip-text').innerHTML = 'Prefilled from Eternum case <strong>' + p.get('case_number') + '</strong>';
    }
    if (p.toString()) showNotification('Case data prefilled from Eternum ✓');
  }

  
});


function selectTone(btn) {
  document.querySelectorAll('.tone-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedTone = btn.dataset.tone;
  updateStepDots();
}

function updateStepDots() {
  const d1 = document.getElementById('dot1');
  const d2 = document.getElementById('dot2');
  const d3 = document.getElementById('dot3');
  const hasBasicInfo = document.getElementById('firstName').value || document.getElementById('lastName').value;
  if (hasBasicInfo) {
    d1.classList.add('done'); d1.classList.remove('active');
    d2.classList.add('active');
  }
}

document.querySelectorAll('input, textarea, select').forEach(el => {
  el.addEventListener('input', updateStepDots);
});

function showNotification(msg) {
  const n = document.getElementById('notification');
  document.getElementById('notificationText').textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3000);
}

function copyText() {
  const txt = document.getElementById('outputArea').value;
  navigator.clipboard.writeText(txt).then(() => showNotification('Copied to clipboard ✓'));
}

function switchFormat(tab, format) {
  document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentFormat = format;
  if (generatedTexts[format]) {
    document.getElementById('outputArea').value = generatedTexts[format];
    updateWordCount();
  } else if (generatedTexts['full']) {
    reformatCurrentFor(format);
  }
}

function updateWordCount() {
  const text = document.getElementById('outputArea').value;
  const count = text.trim() ? text.trim().split(/\s+/).length : 0;
  document.getElementById('wordCountDisplay').textContent = count > 0 ? `${count} words` : '';
}

document.getElementById('outputArea').addEventListener('input', updateWordCount);

function getFormData() {
  return {
    firstName: document.getElementById('firstName').value || 'the deceased',
    lastName: document.getElementById('lastName').value || '',
    age: document.getElementById('age').value,
    dob: document.getElementById('dob').value,
    dod: document.getElementById('dod').value,
    city: document.getElementById('city').value,
    occupation: document.getElementById('occupation').value,
    survivors: document.getElementById('survivors').value,
    predeceased: document.getElementById('predeceased').value,
    hobbies: document.getElementById('hobbies').value,
    achievements: document.getElementById('achievements').value,
    religion: document.getElementById('religion').value,
    serviceType: document.getElementById('serviceType').value,
    tone: selectedTone,
    wordCount: document.getElementById('wordCount').value,
    newspaper: document.getElementById('newspaper').value,
  };
}

async function generateObituary() {

  if (isGenerating) return;
  isGenerating = true;

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;

  const d = getFormData();

  // Update step dots
  document.getElementById('dot2').classList.remove('active');
  document.getElementById('dot2').classList.add('done');
  document.getElementById('dot3').classList.add('active');

  // Show loading
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('outputText').classList.remove('visible');
  document.getElementById('loadingState').classList.add('visible');
  document.getElementById('outputActions').style.display = 'none';
  document.getElementById('formatTabs').style.display = 'none';
  document.getElementById('formatsBar').classList.remove('visible');

  const prompt = `You are a compassionate funeral home writer with 20 years of experience writing dignified, heartfelt obituaries. Write a ${d.wordCount}-word obituary for the following person.

DETAILS:
- Full Name: ${d.firstName} ${d.lastName}
- Age: ${d.age || 'not provided'}
- Date of Birth: ${d.dob || 'not provided'}
- Date of Passing: ${d.dod || 'not provided'}
- Hometown/City: ${d.city || 'not provided'}
- Occupation: ${d.occupation || 'not provided'}
- Survived by: ${d.survivors || 'not provided'}
- Predeceased by: ${d.predeceased || 'not provided'}
- Passions & Hobbies: ${d.hobbies || 'not provided'}
- Notable character/achievements: ${d.achievements || 'not provided'}
- Religion/Faith: ${d.religion || 'not specified'}
- Service type: ${d.serviceType}

TONE: ${d.tone}

INSTRUCTIONS:
- Write a flowing, dignified obituary in prose (no bullet points, no headers)
- Open with a beautiful, memorable sentence that captures who this person was — not just "passed away on..."
- Weave together their life story naturally
- Mention survivors in a warm, natural way
- Close with something meaningful — a faith note, a memory, or a line about their legacy
- Target approximately ${d.wordCount} words
- Sound like it was written by a skilled human writer who knew the family, NOT like AI
- Do not use clichés like "went home to be with the Lord" unless explicitly religious
- Output ONLY the obituary text, nothing else`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await response.json();

    // Show actual API error if something went wrong
    if (!response.ok || data.error) {
      const errMsg = data.error?.message || `API error ${response.status}`;
      console.error('API Error:', data);
      throw new Error(errMsg);
    }

    const text = data.content?.find(b => b.type === 'text')?.text || '';

    if (!text) {
      throw new Error('Empty response from API — check your key and try again');
    }

    generatedTexts['full'] = text;
    generatedTexts['short'] = null;
    generatedTexts['social'] = null;
    generatedTexts['program'] = null;

    document.getElementById('outputArea').value = text;
    updateWordCount();

    document.getElementById('loadingState').classList.remove('visible');
    document.getElementById('outputText').classList.add('visible');
    document.getElementById('outputActions').style.display = 'flex';
    document.getElementById('formatTabs').style.display = 'flex';
    document.getElementById('formatsBar').classList.add('visible');

    document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.format-tab').classList.add('active');
    currentFormat = 'full';

    showNotification('Tribute generated ✓ Review and edit before sending.');

  } catch (err) {
    document.getElementById('loadingState').classList.remove('visible');
    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('outputArea').value = '';
    const msg = err.message || 'Connection error';
    showNotification('Error: ' + msg);
    console.error('Evermore error:', err);
    document.getElementById('dot3').classList.remove('active');
    document.getElementById('dot2').classList.remove('done');
    document.getElementById('dot2').classList.add('active');
  }

  btn.disabled = false;
  isGenerating = false;
}

async function reformatFor(formatDesc) {
  const fullText = generatedTexts['full'];
  if (!fullText) return;

  showNotification(`Reformatting for ${formatDesc.split(' (')[0]}...`);

  const prompt = `Take this obituary and reformat it specifically for a ${formatDesc}. Keep the same key facts and warmth but adapt the length and format precisely.

ORIGINAL OBITUARY:
${fullText}

Output ONLY the reformatted version, nothing else.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await response.json();
    const text = data.content?.find(b => b.type === 'text')?.text || '';
    document.getElementById('outputArea').value = text;
    updateWordCount();
    showNotification(`Reformatted for ${formatDesc.split(' (')[0]} ✓`);

  } catch (err) {
    showNotification('Error reformatting — please try again');
  }
}

async function reformatCurrentFor(format) {
  const formatMap = {
    'short': 'newspaper notice (100-120 words, just the key facts and service info)',
    'social': 'Facebook memorial post (80-100 words, warm, conversational)',
    'program': 'funeral service program bio (60-80 words, formal, present tense)'
  };

  const fullText = generatedTexts['full'];
  if (!fullText || !formatMap[format]) return;

  const prompt = `Reformat this obituary for a ${formatMap[format]}.

ORIGINAL:
${fullText}

Output ONLY the reformatted text.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': ANTHROPIC_API_KEY, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 500,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await response.json();
    const text = data.content?.find(b => b.type === 'text')?.text || '';
    generatedTexts[format] = text;
    document.getElementById('outputArea').value = text;
    updateWordCount();
  } catch(err) {
    console.error(err);
  }
}

function exportToPDF() {
  const text = document.getElementById('outputArea').value;
  if (!text.trim()) {
    showNotification('Generate a tribute first before exporting.');
    return;
  }

  const firstName = document.getElementById('firstName').value || '';
  const lastName = document.getElementById('lastName').value || '';
  const fullName = (firstName + ' ' + lastName).trim() || 'Tribute';
  const dod = document.getElementById('dod').value || '';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'letter' });

  const margin = 25;
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const contentWidth = pageWidth - margin * 2;

  // Header bar
  doc.setFillColor(26, 22, 18);
  doc.rect(0, 0, pageWidth, 20, 'F');

  // Evermore wordmark
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(13);
  doc.setTextColor(245, 240, 232);
  doc.text('Evermore', margin, 13);

  // Name + date top right
  if (dod) {
    doc.setFontSize(9);
    doc.setTextColor(184, 151, 90);
    doc.text(dod, pageWidth - margin, 13, { align: 'right' });
  }

  // Gold rule
  doc.setDrawColor(184, 151, 90);
  doc.setLineWidth(0.4);
  doc.line(margin, 28, pageWidth - margin, 28);

  // Full name
  doc.setFont('times', 'italic');
  doc.setFontSize(22);
  doc.setTextColor(26, 22, 18);
  doc.text(fullName, pageWidth / 2, 40, { align: 'center' });

  // Subtitle
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(9);
  doc.setTextColor(138, 132, 128);
  doc.text('A Tribute', pageWidth / 2, 48, { align: 'center' });

  // Second rule
  doc.setDrawColor(224, 216, 204);
  doc.setLineWidth(0.3);
  doc.line(margin, 53, pageWidth - margin, 53);

  // Body text
  doc.setFont('times', 'normal');
  doc.setFontSize(11);
  doc.setTextColor(26, 22, 18);

  const lines = doc.splitTextToSize(text, contentWidth);
  let y = 63;
  const lineHeight = 6.5;

  lines.forEach(line => {
    if (y + lineHeight > pageHeight - 20) {
      doc.addPage();
      y = margin;
      // Repeat header rule on new page
      doc.setDrawColor(224, 216, 204);
      doc.setLineWidth(0.3);
      doc.line(margin, margin - 4, pageWidth - margin, margin - 4);
    }
    doc.text(line, margin, y);
    y += lineHeight;
  });

  // Footer
  doc.setDrawColor(224, 216, 204);
  doc.setLineWidth(0.3);
  doc.line(margin, pageHeight - 14, pageWidth - margin, pageHeight - 14);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(8);
  doc.setTextColor(138, 132, 128);
  doc.text('Generated by Evermore — evermoreai.github.io', margin, pageHeight - 8);
  doc.text('For Funeral Professionals', pageWidth - margin, pageHeight - 8, { align: 'right' });

  const filename = fullName.replace(/\s+/g, '_') + '_Obituary.pdf';
  doc.save(filename);
  showNotification('PDF exported ✓');
}
</script>
</body>
</html>
